nextflow.enable.dsl = 2

// Parameters
params {
    // // To do when changing:
    // // - star index: add/remove param in starsolo config file when using GTF file instead of GFF!! 
    // // - demultiplex.nf: adjust groups based on sample wells
    // // - submit_nextflow: change run argument (resume etc)

    // BD RHAPSODY -- NVEC !!
    // baseDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing"
    // outDir = "241106_BD_Rhapsody_Nvec"
    // species = "Nvec"
    // seqTech = "bd_rhapsody"
    // dataDir = "/users/asebe/bvanwaardenburg/git/data"
    // accessions = "/users/asebe/bvanwaardenburg/git/data/accession_lists/Nvec_bd_rhapsody_accessions.txt"
    // ref_star_gtf = "/users/asebe/bvanwaardenburg/git/data/241106_BD_Rhapsody_Nvec/genome/Nvec_v5_merged_annotation_sort.gtf"
    // ref_parse_gtf = "/users/asebe/bvanwaardenburg/git/data/241106_BD_Rhapsody_Nvec/genome/Nvec_v4_merged_annotation_parse_sort.gtf"
    // ref_star_gff = "/users/asebe/bvanwaardenburg/git/data/241106_BD_Rhapsody_Nvec/genome/Nvec_v5_merged_annotation_sort.gtf"
    // ref_fasta = "/users/asebe/bvanwaardenburg/git/data/241106_BD_Rhapsody_Nvec/genome/Nvec_vc1.1_gDNA_mtDNA.fasta"

    // barcodeDemux = "${params.baseDir}/seq_techniques/${params.seqTech}/BD_CLS1.txt"
    // barcodeDir = "${params.baseDir}/seq_techniques/${params.seqTech}/BD_CLS1.txt \
    //               ${params.baseDir}/seq_techniques/${params.seqTech}/BD_CLS2.txt \
    //               ${params.baseDir}/seq_techniques/${params.seqTech}/BD_CLS3.txt"

    // PARSE -- NVEC !!
    baseDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing"
    outDir = "240810_ParseBio_Nvec_Tcas/Nvec_BCA001_BCA002"
    species = "Nvec"
    seqTech = "parse_biosciences"
    dataDir = "/users/asebe/bvanwaardenburg/git/data"
    accessions = "/users/asebe/bvanwaardenburg/git/data/accession_lists/Nvec_1_2_parse_biosciences_accessions.txt"
    ref_star_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Nvec_BCA001_BCA002/genome/Nvec_v5_merged_annotation_sort.gtf"
    ref_star_gff = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Nvec_BCA001_BCA002/genome/Nvec_v5_merged_annotation_sort.gtf"
    ref_parse_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Nvec_BCA001_BCA002/genome/Nvec_v4_merged_annotation_parse_sort.gtf"
    ref_fasta = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Nvec_BCA001_BCA002/genome/Nvec_vc1.1_gDNA_mtDNA.fasta"

    // Custom parameters
    // PARSE -- TCAS !!
    // baseDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing"
    // outDir = "240810_ParseBio_Nvec_Tcas/Tcas_sep"
    // seqTech = "parse_biosciences"
    // species = "Tcas"
    // dataDir = "/users/asebe/bvanwaardenburg/git/data"
    // accessions = "/users/asebe/bvanwaardenburg/git/data/accession_lists/Tcas_parse_biosciences_accessions.txt"
    // ref_star_gff = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gff"
    // ref_star_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gtf"
    // ref_parse_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gtf"
    // ref_fasta = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/GCF_031307605.1_icTriCast1.1_genomic.fna"
    
    // Basic parameters
    barcodeDemux = "${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_n26_R1_v3_4"
    barcodeDir = "${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_n26_R1_v3_4 \
                    ${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_v1 \
                    ${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_R3_v3"
    
    resDir = "${params.dataDir}/${params.outDir}"
    star_config_mkref_N = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_mkref_N.txt"
    star_config_mkref_CR = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_mkref_CR.txt"
    star_config_ED = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_ED.txt"
    star_config_CR = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_CR.txt"
    star_config_CRED = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_CRED.txt"
    barcodeDoublet = params.barcodeDir.split()[0]
}


// Profiles
profiles {
    conda {
        conda.enabled = true
        process {
            withName: 'GENE_EXT' {
                conda = "/users/asebe/bvanwaardenburg/miniconda3/envs/geneext"
            }
            withName: 'DOUBLET_DET' {
                conda = "${params.baseDir}/ext_programs/souporcell/souporcell_env.yaml"
            }
        }
    }
    slurm {
        conda.enabled = true
        process {
            cache = 'lenient'
            queue = 'genoa64'
            executor = "slurm"

            // Default resources
            workDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing/workDir"
            stageInMode = 'symlink'
            stageOutMode = 'move'
            clusterOptions = '--qos=short'
            cpus = '1'
            memory = 6.GB
            time = '3h'

            // Specific resources
            withName: 'DEMULTIPLEX' {
                clusterOptions = '--qos=short'
                cpus = 8
                memory = 20.GB
                time = '3h'
            }
            
            withName: 'GENINDEX_STARSOLO' {
                clusterOptions = '--qos=shorter'
                cpus = 4
                memory = 20.GB
                time = '2h'
            }
            
            withName: 'REFGEN_PARSEBIO' {
                clusterOptions = '--qos=shorter'
                cpus = 4
                memory = 20.GB
                time = '2h'
            }

            withName: 'MAPPING_STARSOLO' {
                clusterOptions = '--qos=long'
                cpus = 8
                memory = 64.GB
                time = '20h'
            }

            withName: 'MAPPING_PARSEBIO' {
                clusterOptions = '--qos=long'
                cpus = 8
                memory = 64.GB
                time = '20h'
            }
            
            withName: 'DOUBLET_DET' {
                clusterOptions = '--qos=short'
                cpus = 2
                memory = 20.GB
                time = '4h'
            }
        }
    }
}

// Manifest
manifest {
    name = 'BCA Pre-processing Pipeline'
    author = 'Bonita van Waardenburg'
    description = 'Pipeline for analysis of single-cell RNA sequencing data'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}

// Execution reports
report {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.resDir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}
