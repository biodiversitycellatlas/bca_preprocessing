nextflow.enable.dsl = 2

// Parameters
params {
    // BD RHAPSODY -- NVEC !!
    // params.experiment = "241106_BD_Rhapsody_Nvec"
    // params.species = "Nvec"
    // params.seqTech = "bd_rhapsody"
    // params.resDir = "${params.dataDir}/${params.experiment}"
    // params.ref_star_gtf = "${params.resDir}/genome/Nvec_v5_merged_annotation_sort.gtf"
    // params.ref_parse_gtf = "${params.resDir}/genome/Nvec_v4_merged_annotation_parse_sort.gtf"
    // params.ref_fasta = "${params.resDir}/genome/Nvec_vc1.1_gDNA_mtDNA.fasta"

    // params.barcodeDir = "./seq_techniques/${params.seqTech}/BD_CLS1.txt \
    //                      ./seq_techniques/${params.seqTech}/BD_CLS2.txt \
    //                      ./seq_techniques/${params.seqTech}/BD_CLS3.txt"

    // PARSE -- NVEC !!
    // params.experiment = "240810_ParseBio_Nvec_Tcas"
    // params.species = "Nvec"
    // params.seqTech = "parse_biosciences"
    // params.dataDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing/data"
    // params.resDir = "${params.dataDir}/${params.experiment}/${params.species}_testIntegr"
    // params.ref_star_gtf = "${params.resDir}/genome/Nvec_v5_merged_annotation_sort.gtf"
    // params.ref_parse_gtf = "${params.resDir}/genome/Nvec_v4_merged_annotation_parse_sort.gtf"
    // params.ref_fasta = "${params.resDir}/genome/Nvec_vc1.1_gDNA_mtDNA.fasta"

    // Custom parameters
    // PARSE -- TCAS !!
    baseDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing"
    outDir = "240810_ParseBio_Nvec_Tcas/Tcas"
    seqTech = "parse_biosciences"
    species = "Tcas"
    dataDir = "/users/asebe/bvanwaardenburg/git/data"
    accessions = "/users/asebe/bvanwaardenburg/git/data/accession_lists/Tcas_parse_biosciences_accessions.txt"
    ref_star_gff = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gff"
    ref_star_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gtf"
    ref_parse_gtf = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/genomic.gtf"
    ref_fasta = "/users/asebe/bvanwaardenburg/git/data/240810_ParseBio_Nvec_Tcas/Tcas/genome/GCF_031307605.1_icTriCast1.1_genomic.fna"
    
    // Basic parameters
    barcodeDemux = "${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_n26_R1_v3_4.csv"
    barcodeDir = "${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_n26_R1_v3_4 \
                    ${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_v1 \
                    ${params.baseDir}/seq_techniques/${params.seqTech}/bc_data_R3_v3"
    
    resDir = "${params.dataDir}/${params.outDir}"
    star_config = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo.txt"
    star_config_CR = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_CR.txt"
    star_config_CRED = "${params.baseDir}/seq_techniques/${params.seqTech}/config_${params.seqTech}_starsolo_CRED.txt"
    barcodeDoublet = params.barcodeDir.split()[0]
}


// Profiles
profiles {
    conda {
        conda.enabled = true
        process {
            withName: 'GENE_EXT' {
                conda = "/users/asebe/bvanwaardenburg/miniconda3/envs/geneext"
            }
            withName: 'DOUBLET_DET' {
                conda = "${params.baseDir}/ext_programs/souporcell/souporcell_env.yaml"
            }
        }
    }
    slurm {
        process {
            cache = 'lenient'
            queue = 'genoa64'
            cpus = '1'
            executor = "slurm"
            workDir = "/users/asebe/bvanwaardenburg/git/bca_preprocessing/workDir"
            stageInMode = 'symlink'
            stageOutMode = 'move'
            clusterOptions = { task.time <= 3.h ? '--qos=shorter' : 
                (task.time <= 6.h ? '--qos=short' : 
                (task.time <= 12.h ? '--qos=normal' : 
                (task.time <= 24.h ? '--qos=long' : 
                (task.time <= 48.h ? '--qos=vlong' : '--qos=marathon' )))) }
 
            withLabel: big_cpus {
                clusterOptions = '--qos=short'
                cpus = 5
                time = '2h'
                memory = 10.GB
            }
 
            withLabel: big_mem {
                clusterOptions = '--qos=short'
                time = '2h'
                memory = 30.GB
            } 
        }
    }
}

// Manifest
manifest {
    name = 'BCA Pre-processing Pipeline'
    author = 'Bonita van Waardenburg'
    description = 'Pipeline for analysis of single-cell RNA sequencing data'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}

// Execution reports
report {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.resDir}/pipeline_info/execution_trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.resDir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}
