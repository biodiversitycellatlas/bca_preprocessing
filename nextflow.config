nextflow.enable.dsl = 2

conda {
    enabled = true
    // Set the conda create timeout to verify environment being used for each process
    createTimeout = '1h' 
}


// Global defaults
params {
    // Directory parameters
    code_dir =              ""
    output_dir =            "../output_dir"
    fastq_dir =             null
    protocol =              null
    seqspec_file =          null
    n_expected_cells =      3000

    // Sequencing-specific parameters
    parsebio_groups =       [[]]
    fastq_chunks =          10

    // Reference parameters
    ref_fasta =             null
    ref_gtf =               null
    ref_parse_gtf =         "${params.ref_gtf}"
    mt_contig =             "^MT"
    grep_rrna =             "rRNA"

    mapping_software =      "starsolo"

    // Conditional parameters
    perform_geneext =           true
    perform_featurecounts =     true
    perform_kraken =            false
    kraken_db_path =            null
    perform_cellbender =        false

    // Commercial software
    cellranger_dir =            null
    bdrhap_pipeline_dir =       null
    parsebio_pipeline_dir =     null

    // Config options
    trace_report_suffix          = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Define profiles for config files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow requires the custom config files to be defined in the nextflow.config 
    file as a profile, to be able to reference the params in this file.
----------------------------------------------------------------------------------------
*/
profiles {
    slurm {
        process {
            queue = 'genoa64'
            executor = "slurm"
            clusterOptions = '--qos=short'
        }
    }
    /* ======= !!! EDIT BELOW TO INCLUDE YOUR CUSTOM CONFIG FILES !!! ======= */
    '240810_ParseBio_Nvec_BCA3_BCA4' {
        includeConfig 'conf/240810_ParseBio_Nvec_BCA3_BCA4.config'
    }
    /* ======= !!! EDIT ABOVE TO INCLUDE YOUR CUSTOM CONFIG FILES !!! ======= */
}


// Include seqtech-specific parameters
includeConfig "conf/seqtech_parameters.config"


/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Defines resources, module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {
    conda = "${params.code_dir}/env/bca_env.yml"
    cache = 'lenient'
    queue = 'genoa64'
    executor = "slurm"

    // Default resources
    stageInMode = 'symlink'
    stageOutMode = 'move'
    clusterOptions = '--qos=short'
    cpus = '1'
    memory = 6.GB
    time = '3h'

    // Process-specific resources
    withName: 'KRAKEN_CREATE_DB' {
        clusterOptions = '--qos=shorter'
        memory = 48.GB
        time = '2h'
    }

    withName: 'KRAKEN' {
        conda = "${params.code_dir}/env/kraken_env.yml"
        clusterOptions = '--qos=normal'
        memory = 48.GB
        cpus = 4
        time = '10h'
    }

    // Process-specific resources: parse_workflow()
    withName: 'PARSEBIO_PIPELINE_DEMUX' {
        clusterOptions = '--qos=shorter'
        cpus = 1
        memory = 20.GB
        time = '2h'
    }

    withName: 'PARSEBIO_PIPELINE_MKREF' {
        conda = "${params.code_dir}/env/spipe_env.yml"
        clusterOptions = '--qos=shorter'
        cpus = 1
        memory = 20.GB
        time = '2h'
    }

    withName: 'PARSEBIO_PIPELINE' {
        conda = "${params.code_dir}/env/spipe_env.yml"
        clusterOptions = '--qos=short'
        cpus = 4 
        time = '5h' 
        memory = '32 GB' 
    }


    // Process-specific resources: bd_rhapsody_workflow()
    withName: 'RM_VARBASES' {
        clusterOptions = '--qos=short'
        memory = 32.GB
        time = '5h'
    }

    withName: 'BDRHAP_PIPELINE_MKREF' {
        conda = "${params.code_dir}/env/bd_pipe_env.yml"
        clusterOptions = '--qos=shorter'
        cpus = 1
        memory = 24.GB
        time = '2h'
    }

    withName: 'BDRHAP_PIPELINE' {
        conda = "${params.code_dir}/env/bd_pipe_env.yml"
        clusterOptions = '--qos=normal'
        cpus = 4
        memory = 86.GB
        time = '10h'
    }

    // Process-specific resources: oak_seq_workflow()
    withName: 'CR_PIPELINE_MKREF' {
        clusterOptions = '--qos=shorter'
        cpus = 1
        memory = 24.GB
        time = '1h'
    }

    withName: 'CR_PIPELINE' {
        clusterOptions = '--qos=normal'
        cpus = 4
        memory = 32.GB
        time = '7h'
    }

    // Process-specific resources: QC_mapping_workflow()
    withName: 'GENINDEX_STARSOLO' {
        clusterOptions = '--qos=shorter'
        cpus = 4
        memory = 64.GB
        time = '2h'
        ext.args = { params.annot_type == 'GFF' ? '--sjdbGTFtagExonParentTranscript mRNA' : '' }
    }

    withName: 'MAPPING_STARSOLO' {
        clusterOptions = { (params.protocol == 'bd_rhapsody' || params.protocol == 'oak_seq') ? '--qos=vlong' : '--qos=short' }
        memory = { (params.protocol == 'bd_rhapsody' || params.protocol == 'oak_seq') ? '112 GB' : '32 GB' }
        cpus = { (params.protocol == 'bd_rhapsody' || params.protocol == 'oak_seq') ? 8 : 4 }
        time = { (params.protocol == 'bd_rhapsody' || params.protocol == 'oak_seq') ? '28h' : '5h' }
        ext.args = { (params.protocol == 'bd_rhapsody' || params.protocol == 'oak_seq') ? '--limitBAMsortRAM 7485893740' : '' }
    }

    withName: 'GENINDEX_ALEVIN' {
        conda = "${params.code_dir}/env/alevin_env.yml"
        clusterOptions = '--qos=short'
        cpus = 4
        memory = 64.GB
        time = '4h'
    }

    withName: 'MAPPING_ALEVIN' {
        conda = "${params.code_dir}/env/alevin_env.yml"
        clusterOptions = '--qos=short'
        cpus = 4
        memory = 64.GB
        time = '5h'
    }

    withName: 'GENE_EXT' {
        conda = "${params.code_dir}/env/geneext_env.yml"
        clusterOptions = '--qos=shorter'
        memory = 64.GB
        cpus = 4
        time = '2h'
    }

    // Process-specific resources: filtering_workflow()
    withName: 'CELLBENDER' {
        conda = "${params.code_dir}/env/cellbender_env.yml"
        clusterOptions = '--qos=long'
        memory = 64.GB
        cpus = 8
        time = '16h'
    }
}


// Automatically removes work directories of succesful jobs to reduce storage
// cleanup = true

// Execution reports
timeline {
    enabled = true
    file    = "${params.output_dir}/pipeline_info/execution_timeline_${params.trace_report_suffix}.html"
}
report {
    enabled = true
    file    = "${params.output_dir}/pipeline_info/execution_report_${params.trace_report_suffix}.html"
}
trace {
    enabled = true
    file    = "${params.output_dir}/pipeline_info/execution_trace_${params.trace_report_suffix}.txt"
}
dag {
    enabled = true
    file    = "${params.output_dir}/pipeline_info/pipeline_dag_${params.trace_report_suffix}.html"
}

// Manifest
manifest {
    name = 'BCA Pre-processing Pipeline'
    author = 'Bonita van Waardenburg'
    contributors    = [
        // Field with the details of the contributors to your pipeline. New with Nextflow version 24.10.0
        [
            name: 'Bonita van Waardenburg',
            affiliation: 'Centre de Regulació Genòmica (CRG)',
            email: 'bonita.vanwaardenburg@crg.eu',
            github: 'https://github.com/bonitavw',
            contribution: ['author', 'maintainer'],
            orcid: ''
        ],
    ]
    description = 'Biodiversity Cell Atlas Pre-processing Pipeline'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}
