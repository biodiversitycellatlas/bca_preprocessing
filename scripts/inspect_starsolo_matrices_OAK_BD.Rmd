---
title: "Create Visualizations"
author: "Bonita van Waardenburg"
date: "2025-02-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Load Packages

```{r pkgs, message=FALSE, warning=FALSE}
library(data.table)
library(Matrix)
library(ggplot2)
library(RColorBrewer)
library(ggridges)
library(scales)
library(dplyr)
library(patchwork)

```

## Set variables
```{r set_vars}

data_dir <- "~/git/data/250221_OAKseq_Nvec"

raw_names <- c("AACGAACTGT",
               "AGGTAACACT", 
               "TTCGACAAGC",
               "TTTATCCTTG") 


# Initialize a nested list to store expanded paths
raw_dirs <- list()

# Loop through each raw_name and expand wildcards
for (raw_name in raw_names) {
  
  # Construct the base path with wildcards
  path_pattern <- file.path(data_dir, "mapping_STARsolo", "*", raw_name, "*_Solo.out", "GeneFull_Ex50pAS", "raw")
  
  # Expand the wildcard paths
  expanded_paths <- Sys.glob(path_pattern)
  
  if (length(expanded_paths) > 0) {
    
    for (path in expanded_paths) {
      # Extract condition names: Remove prefix to keep only the experiment condition (e.g., DCE_FH)
      file_name <- basename(dirname(dirname(dirname(path))))
      
      # Extracts everything after {8}-{8}
      condition_names <- gsub(".*_", "", file_name) 
      dirname <- basename(dirname(dirname(dirname(dirname(path)))))
      
      # Append the path to the condition name
      if (!is.null(raw_dirs[[dirname]][[condition_names]])) {
        # If the condition name already exists, append the new path
        raw_dirs[[dirname]][[condition_names]] <- c(raw_dirs[[dirname]][[condition_names]], path)
      } else {
        # Otherwise, create a new list entry
        raw_dirs[[dirname]][[condition_names]] <- path
      }
    }
 
  }
}

raw_dirs
```



## Load Data

```{r load_data}

read_star_data <- function(directory, dataset_name) {
  
  # Read matrix, features, and barcodes
  mat <- Matrix::readMM(file.path(directory, "matrix.mtx"))
  features <- data.table::fread(file.path(directory, "features.tsv"), header = FALSE)
  barcodes_dt <- data.table::fread(file.path(directory, "barcodes.tsv"), header = FALSE)
  
  # Assign row and column names to the matrix
  rownames(mat) <- features$V1
  colnames(mat) <- barcodes_dt$V1
  
  # Compute per-cell summaries
  cell_umis <- Matrix::colSums(mat)
  cell_genes <- Matrix::colSums(mat > 0)
  
  # Create a data.table for cells
  cell_dt <- data.table(
    cells      = colnames(mat),
    cell_sizes = cell_umis,
    cell_genes = cell_genes,
    dataset    = dataset_name
  )

  # Compute per-gene summaries
  gene_counts <- Matrix::rowSums(mat)
  gene_dt <- data.table(
    gene      = rownames(mat),
    gene_umis = gene_counts,
    dataset   = dataset_name
  )
  
  return(list(cell_summary = cell_dt, gene_summary = gene_dt))
}


# Initialize lists for summaries
cell_summary_list <- list()
gene_summary_list <- list()

# Process each dataset (first level of nesting)
for (dataset_name in names(raw_dirs)) {
  
  # Process each condition (second level of nesting)
  for (condition in names(raw_dirs[[dataset_name]])) {
    
    directory <- raw_dirs[[dataset_name]][[condition]]  # Get the directory path
    
    # Read data
    res <- read_star_data(directory, paste0(dataset_name, "_", condition))
    
    # Store results with meaningful names
    cell_summary_list[[paste0(dataset_name, "_", condition)]] <- res$cell_summary
    gene_summary_list[[paste0(dataset_name, "_", condition)]] <- res$gene_summary

  }
}

# Check results
print(cell_summary_list)
print(gene_summary_list)

```


Set UMI count thresholds and color palette

```{r}

# Convert nested lists into a single data.table for easier filtering
cell_summary_dt <- rbindlist(cell_summary_list, idcol = "dataset")
gene_summary_dt <- rbindlist(gene_summary_list, idcol = "dataset")


# ---- Define filtering thresholds ----
umi_thr <- c(10, 10000)  # UMI count thresholds per cell
gen_thr <- 10             # Minimum genes detected per cell

# Filter for cells that pass the threshold
filt_cells <- cell_summary_dt[
  cell_sizes >= umi_thr[1] & cell_sizes <= umi_thr[2] & cell_genes >= gen_thr
]

# Filter for cells with positive UMI counts (to avoid -Inf in log10 plots)
sum_cells_plot <- cell_summary_dt[cell_sizes > 0]
sum_genes_plot <- gene_summary_dt[gene_umis > 0]

# ---- Define a dynamic color palette ----
dataset_names <- unique(cell_summary_dt$dataset)

# Generate a color palette with enough distinct colors
num_datasets <- length(dataset_names)
data_cols <- setNames(colorRampPalette(brewer.pal(9, "Set1"))(num_datasets), dataset_names)

# Remove duplicate dataset column
sum_cells_plot <- sum_cells_plot %>% distinct()
filt_cells <- filt_cells %>% distinct()

```



```{r}
# Load required libraries
library(ggplot2)
library(tidyr)
library(dplyr)
library(scales)  # For percentage formatting
# Load necessary libraries
library(ggplot2)
library(tidyr)
library(patchwork)  # For merging plots

library(scales)  # For percentage formatting


# Create a data frame with the metadata for each pipeline and sample.
metadata <- data.frame(
  Pipeline = rep(c("CellRanger_v4_merged", "STARsolo_v6_merged", "CellRanger_v4_extended", "STARsolo_v4_extended"), each = 4),
  Sample = rep(c("AACGAACTGT", "AGGTAACACT", "TTCGACAAGC", "TTTATCCTTG"), times = 4),
  Mean_Reads = c(16176, 21751, 24205, 16777,
                 6676, 8317, 7980, 6282,
                 17805, 24753, 28007, 18431,
                 7145, 9027, 8901, 7030),
  Median_UMI = c(464, 507, 495, 433,
                 621, 679, 608, 551,
                 566, 644, 640, 526,
                 685, 772, 914, 635),
  Median_Genes = c(334, 355, 348, 315,
                   409, 438, 400, 369,
                   386, 421, 418, 361,
                   444, 484, 451, 414),
  Total_Genes = c(18799, 18814, 18790, 18771,
                  18743, 18796, 18754, 18745,
                  22663, 22760, 22641, 22555,
                  22500, 22644, 22538, 22419),
  Intronic = c(6.40, 5.90, 5.60, 6.10,
               19.87, 20.47, 20.65, 20.18,
               0.00, 0.00, 0.00, 0.00,
               2.75, 2.52, 2.55, 2.72),
  Intergenic = c(4.00, 3.80, 3.70, 3.90,
                 0.00, 0.00, 0.00, 0.00,
                 1.70, 1.70, 1.70, 1.70,
                 0.00, 0.00, 0.00, 0.00),
  mtDNA = c(0.00, 0.00, 0.00, 0.00,
            1.03, 1.14, 1.19, 1.10,
            0.00, 0.00, 0.00, 0.00,
            1.03, 1.14, 1.19, 1.10),
  N_cells = c(7911, 6943, 6535, 7800, 
              5776, 5134, 5404, 6124, 
              7187, 6101, 5648, 7100,
              5618, 4895, 4996, 5634),
  Saturation = c(85.30, 86.70, 87.50, 86.10,
                 85.17, 86.53, 87.35,85.94,
                 84.40, 85.70, 86.50, 85.10,
                 84.57, 85.89, 86.73, 85.35)
)


# Convert the data frame to a long format for plotting.
metadata_long <- pivot_longer(
  metadata,
  cols = c("Mean_Reads", "Median_UMI", "Median_Genes", "Total_Genes", "Intronic", "Intergenic", "mtDNA", "N_cells", "Saturation"),
  names_to = "Metric",
  values_to = "Value"
)

# Define human-readable labels for facets (metrics)
metric_labels <- c(
  "Mean_Reads" = "Mean Reads per Cell",
  "Median_UMI" = "Median UMI Counts per Cell",
  "Median_Genes" = "Median Genes per Cell",
  "Total_Genes" = "Total Genes Detected",
  "Intronic" = "% Mapped to Intronic regions",
  "Intergenic" = "% Mapped to Intergenic Regions",
  "mtDNA" = "% mtDNA in total mapped reads",
  "N_cells" = "Number of Cells",
  "Saturation" = "Saturation (%)"
)

# Define human-readable sample names
sample_labels <- c(
  "AACGAACTGT" = "AACGAACTGT",
  "AGGTAACACT" = "AGGTAACACT",
  "TTCGACAAGC" = "TTCGACAAGC",
  "TTTATCCTTG" = "TTTATCCTTG"
)




# Define which metrics are percentages
percentage_metrics <- c("Intronic", "Intergenic", "mtDNA", "Saturation")

# Split data into two sets: one for percentages, one for regular values
metadata_numeric <- metadata_long %>% filter(!Metric %in% percentage_metrics)
metadata_percent <- metadata_long %>% filter(Metric %in% percentage_metrics)

# ---- Plot for numeric metrics ----
plot_numeric <- ggplot(metadata_numeric, aes(x = Sample, y = Value, fill = Pipeline)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Metric, scales = "free_y", nrow = 2, ncol = 3, labeller = as_labeller(metric_labels)) +  
  labs(x = "Sample", y = "Value") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_y_continuous(labels = scales::comma_format())  # Use comma for numeric values

# ---- Plot for percentage metrics ----
plot_percent <- ggplot(metadata_percent, aes(x = Sample, y = Value, fill = Pipeline)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Metric, scales = "free_y", nrow = 1, ncol = 4, labeller = as_labeller(metric_labels)) +  
  labs(x = "Sample", y = NULL) +  # Remove y-axis label to prevent duplication
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))  # Convert fraction to percentage

# ---- Merge the two plots with a single general title ----
combined_plot <- (plot_numeric / plot_percent) + 
  plot_annotation(title = "Comparison of Metadata Metrics Across Pipelines") &
  theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))  # Center title

# Display the merged plot
print(combined_plot)

# Save as high-quality JPG
ggsave("barchart_combined.jpg", combined_plot, width = 14, height = 10, dpi = 300)

```



```{r}
library(ggplot2)
library(Matrix)
library(dplyr)
library(scales)

# ---- Load the matrix file ----
load_matrix <- function(directory) {
  mat <- readMM(file.path(directory, "matrix.mtx"))
  features <- read.table(file.path(directory, "features.tsv"), header = FALSE, stringsAsFactors = FALSE)$V1
  barcodes <- read.table(file.path(directory, "barcodes.tsv"), header = FALSE, stringsAsFactors = FALSE)$V1

  # Assign proper dimensions
  rownames(mat) <- features  # Genes should match rows
  colnames(mat) <- barcodes  # Barcodes should match columns
  
  # Compute total UMI counts per barcode
  umi_counts <- colSums(mat)
  
  # Convert to data frame
  umi_df <- data.frame(
    Barcode = barcodes,
    UMI_Count = umi_counts
  )
  
  return(umi_df)
}

# ---- Load data (modify directory path) ----
directory <- "~/git/data/250221_OAKseq_Nvec/mapping_STARsolo/mapping_STARsolo_fastqsplitted_v6_merged/AACGAACTGT/AACGAACTGT_Solo.out/GeneFull_Ex50pAS/raw/"
umi_df <- load_matrix(directory)


# ---- Prepare data for knee plot ----
umi_df <- umi_df %>%
  arrange(desc(UMI_Count)) %>%
  mutate(Rank = row_number())

# ---- Set cutoff threshold ----
umi_cutoff <- 345  # Adjust based on your cell-calling threshold

# ---- Add color condition ----
umi_df <- umi_df %>%
  mutate(Color = ifelse(UMI_Count >= umi_cutoff, "Above Cutoff", "Below Cutoff"))

# ---- Plot Knee Plot with Color Change ----
knee_plot <- ggplot(umi_df, aes(x = Rank, y = UMI_Count, color = Color)) +
  geom_line(size = 1) +  # Color changes at threshold
  geom_vline(xintercept = sum(umi_df$UMI_Count >= umi_cutoff), linetype = "dashed", color = "red") +
  scale_y_log10(labels = scales::comma) +  # Log scale for better visualization
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Knee Plot of UMI Counts with Cell Calling Cutoff",
    x = "Barcode Rank",
    y = "Total UMI Counts",
    color = "Cell Quality"
  ) +
  theme_minimal()

# Display the plot
print(knee_plot)

# Save as high-resolution image
ggsave("knee_plot.png", knee_plot, width = 8, height = 6, dpi = 300)


```


Plot UMI/cell distributions as density plot

```{r}

gp_umis_dist <- ggplot(sum_cells_plot[cell_sizes > 50], aes(x = cell_sizes, y = dataset, fill = dataset)) +
  ggridges::geom_density_ridges2() +
  scale_x_continuous(trans = "log10", labels = label_math('log10', math_format(10^.x))) +
  scale_fill_manual(values = data_cols) +
  labs(x = "UMIs per cell (UMI > 50)", y = "") +
  theme(legend.position = "none")
gp_umis_dist
```

```{r}
# Bar plot: Number of cells passing the filter
gp_cells <- ggplot(filt_cells, aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Cells (100 ≤ UMI ≤ 10,000, genes ≥10)", x = "", y = "") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
gp_cells

# Bar plot: Number of non-cells (cells that did not pass the filter)
gp_non_cells <- ggplot(sum_cells_plot[!(cells %in% filt_cells$cells)], aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Non-cells", x = "", y = "") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
gp_non_cells

```


```{r}

# Load required libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Create a data frame with the filtered cell counts for each sample from each STARsolo run.
star_data <- data.frame(
  Sample = rep(c("AACGAACTGT", "AGGTAACACT", "TTCGACAAGC", "TTTATCCTTG"), 2),
  Run = rep(c("STARsolo_v6", "STARsolo_v4_extended", "CellRanger_v4_merged", "CellRanged_v4_extended"), each = 4),
  N_cells = c(5776, 5134, 5404, 6124, 5618, 4895, 4996, 5634, 7911, 6943, 6535, 7800, 7187, 6101, 5648, 7100)
)

# --- Paired Bar Chart ---
# Each sample will have two bars (one per run) shown side-by-side.
ggplot(star_data, aes(x = Sample, y = N_cells, fill = Run)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    title = "Filtered Cell Counts by STARsolo Run",
    x = "Sample",
    y = "Number of Filtered Cells"
  ) +
  theme_minimal()

# --- Boxplot ---
# This shows the distribution of filtered cell counts across the samples for each STARsolo run.
ggplot(star_data, aes(x = Run, y = N_cells, fill = Run)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Filtered Cell Counts",
    x = "STARsolo Run",
    y = "Number of Filtered Cells"
  ) +
  theme_minimal()



library(ggplot2)
library(dplyr)
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(ggrepel)

# Define the categories and percentages
Perc_Maptypes <- data.frame(
  Category = c("% Uniquely Mapped Reads", 
               "% Multi-Mapped Reads", 
               "% Multi-Mapped Reads: Too Many", 
               "% Unmapped: Too Short", 
               "% Unmapped: Other"),
  Percentage = c(41.60, 5.38, 6.56, 7.88, 38.57)
)

# Add a column for labels with percentage values
Perc_Maptypes <- Perc_Maptypes %>%
  mutate(Label = paste0(Category, ": ", Percentage, "%"))

# Define a cute pastel color palette
cute_colors <- c("#FF9999", "#66B2FF", "#99FF99", "#FFCC99", "#CC99FF")

# Create the pie chart
pie_chart <- ggplot(Perc_Maptypes, aes(x = "", y = Percentage, fill = Category)) +
  geom_bar(stat = "identity", width = 1, color = "white") +  # Creates a bar chart to be converted into a pie chart
  coord_polar(theta = "y") +  # Convert to pie chart
  scale_fill_manual(values = cute_colors) +  # Apply pastel colors
  geom_label_repel(aes(label = Label), 
                   position = position_stack(vjust = 0.5), 
                   size = 4, 
                   color = "black", 
                   box.padding = 0.3,
                   point.padding = 0.2, 
                   segment.color = "grey50") +  # Use ggrepel for better spacing
  labs(title = "Mapping Type Distribution") + 
  theme_void() +  # Remove axes and grid
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Center the title
    legend.position = "none"  # Remove default legend (labels are inside the pie)
  )

# Display the chart
print(pie_chart)



```

```{r}
# Unique genes with at least one UMI
unique_genes <- unique(sum_genes_plot[gene_umis > 0, .(dataset, gene)])

gp_genes <- ggplot(unique_genes, aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Genes (UMI > 0)", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

gp_genes
```

```{r}
# Boxplot: UMIs per cell (filtered cells)
gp_umis_cells <- ggplot(filt_cells, aes(x = dataset, y = cell_sizes, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(umi_thr[1], NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "UMIs per cell", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_umis_cells

# Boxplot: Genes per cell (filtered cells)
gp_genes_cells <- ggplot(filt_cells, aes(x = dataset, y = cell_genes, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(gen_thr, NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "Genes per cell", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_genes_cells


```

```{r}
sum_genes_plot <- sum_genes_plot %>% distinct()

gp_umi_genes <- ggplot(sum_genes_plot, aes(x = dataset, y = gene_umis, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(10, NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "UMIs per gene", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_umi_genes

```




```{r}

# Filter top 10,000 cells based on UMI count
cell_n <- 10000
ttl <- sprintf("Top %s BC", cell_n)
sub <- sprintf("top%s", cell_n)

dist_dt <- sum_cells_plot[order(dataset, -cell_sizes), .SD[1:pmin(.N, cell_n)], by = dataset]
dist_dt <- dist_dt[cell_sizes > 0]

# UMI distribution plot
gp_umis_dist <- ggplot(dist_dt, aes(cell_sizes, dataset, fill = dataset)) +
  ggridges::geom_density_ridges2() +
  geom_vline(xintercept = 345, linetype = "dashed", color = "red") +
  scale_x_continuous(
    breaks = 10^seq(1, 5),
    transform = "log10", labels = trans_format('log10', math_format(10^.x))
  ) +
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_manual(values = data_cols) +
  theme(
    strip.text = element_blank(),
    legend.position = "none"
  ) +
  labs(y = "", x = "UMIs / cell barcode", title = ttl)

# Number of cells per dataset
gp_cells <- ggplot(filt_cells, aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, hjust = -0.2) +
  coord_flip() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  ) +
  labs(x = "", y = "", title = sprintf("Cells\n(%s<UMI<%s)", umi_thr[1], umi_thr[2]))

# Set Variables 
scdb_fig_dir <- "R_images"
map_dir <- "2502_OAK"
sub <- "top10000" 

# Ensure the directory exists before saving
if (!dir.exists(scdb_fig_dir)) {
  dir.create(scdb_fig_dir, recursive = TRUE)
}

# Arrange plots vertically
combined_plot <- gp_umis_dist + gp_cells + plot_layout(nrow = 1)

# Save the plot
ggsave(file.path(scdb_fig_dir, sprintf("UMI_dist_%s_%s.pdf", map_dir, sub)), 
       combined_plot, width = 14, height = 12)



```



```{r}
# ---- Per Dataset Plots ----

# Number of cells
gp_cells <- ggplot(filt_cells, aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, angle = 90, hjust = -0.2) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = sprintf("Cells\n(%s<UMI<%s)", umi_thr[1], umi_thr[2]))

# Number of genes
gp_genes <- ggplot(unique(sum_genes_plot[gene_umis > 0, .(dataset, species, gene)]), aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, angle = 90, hjust = -0.2) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "none") +
  labs(x = "", y = "", title = "Genes\n(UMI>0)")

# ---- Per Cell Plots ----

# Plot cell UMI counts
gp_umis_cells <- ggplot(filt_cells, aes(dataset, cell_sizes, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = filt_cells[, median(cell_sizes), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  scale_y_continuous(trans = "log10", limits = c(umi_thr[1], NA)) +
  scale_fill_manual(values = data_cols) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = "UMIs / cell")

# Plot number of genes
gp_genes_cells <- ggplot(filt_cells, aes(dataset, cell_genes, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = filt_cells[, median(cell_genes), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  scale_y_continuous(trans = "log10", limits = c(NA, NA)) +
  scale_fill_manual(values = data_cols) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = "Genes / cell")

# Plot gene UMI counts 
gp_umi_genes <- ggplot(sum_genes_plot, aes(dataset, gene_umis, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = sum_genes_plot[gene_umis > 0, median(gene_umis), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "none") +
  scale_fill_manual(values = data_cols) +
  labs(x = "", y = "", title = "UMIs / gene")

# Combine plots
gps <- (gp_cells / gp_genes) | (gp_umis_cells / gp_genes_cells / gp_umi_genes)
ggsave(file.path(scdb_fig_dir, sprintf("cells_genes_%s.pdf", map_dir)), gps, width = 26, height = 15)


```
