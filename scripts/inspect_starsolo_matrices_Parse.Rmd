---
title: "Create Visualizations"
author: "Bonita van Waardenburg"
date: "2025-02-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Load Packages

```{r pkgs, message=FALSE, warning=FALSE}
library(data.table)
library(Matrix)
library(ggplot2)
library(RColorBrewer)
library(ggridges)
library(scales)
library(dplyr)
library(patchwork)

# helper functions
source("~/git/bca_preprocessing/ext_programs/metacell-downstream-functions/Downstream_functions.R")
source("~/git/bca_preprocessing/ext_programs/metacell-downstream-functions/metacell_downstream_functions/Modified_functions.R")
```

## Set variables
```{r set_vars}

data_dir <- "~/git/data/250115_ParseBio_Nvec_Tcas_Pliv_Cele"

raw_names <- c("Nvec_BCA001_BCA002",
               "Nvec_BCA003_BCA004",
               "Nvec_BCA009_BCA010",
               "Nvec_BCA013_BCA014",
               "Nvec_nuclei_BCA015_BCA016",
               "Pliv_BCA011_BCA012",
               "Pliv_BCA013_BCA014",
               "Tcas_BCA003_BCA004",
               "Tcas_nuclei_BCA015_BCA016",
               "Cele_nuclei_BCA015_BCA016") 


# Initialize a nested list to store expanded paths
raw_dirs <- list()

# Loop through each raw_name and expand wildcards
for (raw_name in raw_names) {
  
  # Construct the base path with wildcards
  path_pattern <- file.path(data_dir, raw_name, "mapping_STARsolo", "*_CRNF_SPIPE", "*", "*_Solo.out", "Gene", "raw")
  
  # Expand the wildcard paths
  expanded_paths <- Sys.glob(path_pattern)
  
  if (length(expanded_paths) > 0) {
    
    for (path in expanded_paths) {
      # Extract condition names: Remove prefix to keep only the experiment condition (e.g., DCE_FH)
      file_name <- basename(dirname(dirname(dirname(path))))
      
      # Extracts everything after {8}-{8}
      condition_names <- gsub(".*_([A-Z0-9]{8}-[A-Z0-9]{8})_", "", file_name) 
      lib_name <- gsub("_.*_([A-Z0-9]{8}-[A-Z0-9]{8})_.*", "", file_name)
      species <- gsub("_BCA.*", "", raw_name)
      dirname <- paste(species, lib_name, sep="_")
      
      # Ensure `raw_dirs[[dirname]]` is initialized as a list
      if (!is.list(raw_dirs[[dirname]])) {
        raw_dirs[[dirname]] <- list()
      }
      
      # Append the path to the condition name
      if (!is.null(raw_dirs[[dirname]][[condition_names]])) {
        # If the condition name already exists, append the new path
        raw_dirs[[dirname]][[condition_names]] <- c(raw_dirs[[dirname]][[condition_names]], path)
      } else {
        # Otherwise, create a new list entry
        raw_dirs[[dirname]][[condition_names]] <- path
      }
    }
 
  }
}

raw_dirs
```



## Load Data

```{r load_data}

read_star_data <- function(directory, dataset_name) {
  
  # Read matrix, features, and barcodes
  mat <- Matrix::readMM(file.path(directory, "matrix.mtx"))
  features <- data.table::fread(file.path(directory, "features.tsv"), header = FALSE)
  barcodes_dt <- data.table::fread(file.path(directory, "barcodes.tsv"), header = FALSE)
  
  # Assign row and column names to the matrix
  rownames(mat) <- features$V1
  colnames(mat) <- barcodes_dt$V1
  
  # Compute per-cell summaries
  cell_umis <- Matrix::colSums(mat)
  cell_genes <- Matrix::colSums(mat > 0)
  
  # Create a data.table for cells
  cell_dt <- data.table(
    cells      = colnames(mat),
    cell_sizes = cell_umis,
    cell_genes = cell_genes,
    dataset    = dataset_name
  )

  # Compute per-gene summaries
  gene_counts <- Matrix::rowSums(mat)
  gene_dt <- data.table(
    gene      = rownames(mat),
    gene_umis = gene_counts,
    dataset   = dataset_name
  )
  
  return(list(cell_summary = cell_dt, gene_summary = gene_dt))
}


# Initialize lists for summaries
cell_summary_list <- list()
gene_summary_list <- list()

# Process each dataset (first level of nesting)
for (dataset_name in names(raw_dirs)) {
  
  # Process each condition (second level of nesting)
  for (condition in names(raw_dirs[[dataset_name]])) {
    
    directory <- raw_dirs[[dataset_name]][[condition]]  # Get the directory path
    
    # Read data
    res <- read_star_data(directory, paste0(dataset_name, "_", condition))
    
    # Store results with meaningful names
    cell_summary_list[[paste0(dataset_name, "_", condition)]] <- res$cell_summary
    gene_summary_list[[paste0(dataset_name, "_", condition)]] <- res$gene_summary
  }
}

# Check results
print(cell_summary_list)
print(gene_summary_list)

```


Set UMI count thresholds and color palette

```{r}

# Convert nested lists into a single data.table for easier filtering
cell_summary_dt <- rbindlist(cell_summary_list, idcol = "dataset")
gene_summary_dt <- rbindlist(gene_summary_list, idcol = "dataset")

# Extract `species` as the `dirname` without "BCA..."
cell_summary_dt[, species := gsub("_BCA.*", "", dataset)]
gene_summary_dt[, species := gsub("_BCA.*", "", dataset)]

# ---- Define filtering thresholds ----
umi_thr <- c(50, 10000)  # UMI count thresholds per cell
gen_thr <- 10             # Minimum genes detected per cell

# Filter for cells that pass the threshold
filt_cells <- cell_summary_dt[
  cell_sizes >= umi_thr[1] & cell_sizes <= umi_thr[2] & cell_genes >= gen_thr
]

# Filter for cells with positive UMI counts (to avoid -Inf in log10 plots)
sum_cells_plot <- cell_summary_dt[cell_sizes > 0]
sum_genes_plot <- gene_summary_dt[gene_umis > 0]

# ---- Define a dynamic color palette ----
dataset_names <- unique(cell_summary_dt$dataset)

# Generate a color palette with enough distinct colors
num_datasets <- length(dataset_names)
data_cols <- setNames(colorRampPalette(brewer.pal(9, "Set1"))(num_datasets), dataset_names)

# Remove duplicate dataset column
sum_cells_plot <- sum_cells_plot %>% distinct()
filt_cells <- filt_cells %>% distinct()

```



Plot UMI/cell distributions as density plot

```{r}

gp_umis_dist <- ggplot(sum_cells_plot[cell_sizes > 50], aes(x = cell_sizes, y = dataset, fill = dataset)) +
  ggridges::geom_density_ridges2() +
  scale_x_continuous(trans = "log10", labels = label_math('log10', math_format(10^.x))) +
  scale_fill_manual(values = data_cols) +
  labs(x = "UMIs per cell (UMI > 50)", y = "") +
  theme(legend.position = "none")
gp_umis_dist
```

```{r}
# Bar plot: Number of cells passing the filter
gp_cells <- ggplot(filt_cells, aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Cells (100 ≤ UMI ≤ 10,000, genes ≥10)", x = "", y = "") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
gp_cells

# Bar plot: Number of non-cells (cells that did not pass the filter)
gp_non_cells <- ggplot(sum_cells_plot[!(cells %in% filt_cells$cells)], aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Non-cells", x = "", y = "") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
gp_non_cells

```

```{r}
# Unique genes with at least one UMI
unique_genes <- unique(sum_genes_plot[gene_umis > 0, .(dataset, gene)])

gp_genes <- ggplot(unique_genes, aes(x = dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = data_cols) +
  labs(title = "Genes (UMI > 0)", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

gp_genes
```

```{r}
# Boxplot: UMIs per cell (filtered cells)
gp_umis_cells <- ggplot(filt_cells, aes(x = dataset, y = cell_sizes, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(umi_thr[1], NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "UMIs per cell", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_umis_cells

# Boxplot: Genes per cell (filtered cells)
gp_genes_cells <- ggplot(filt_cells, aes(x = dataset, y = cell_genes, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(gen_thr, NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "Genes per cell", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_genes_cells


```

```{r}
sum_genes_plot <- sum_genes_plot %>% distinct()

gp_umi_genes <- ggplot(sum_genes_plot, aes(x = dataset, y = gene_umis, fill = dataset)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10", limits = c(10, NA)) +
  scale_fill_manual(values = data_cols) +
  labs(title = "UMIs per gene", x = "", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
gp_umi_genes

```




```{r}

# ---- Generate UMI Distribution Plots ----

# Filter top 10,000 cells based on UMI count
cell_n <- 10000
ttl <- sprintf("Top %s BC", cell_n)
sub <- sprintf("top%s", cell_n)
dist_dt <- sum_cells_plot[order(dataset, -cell_sizes), .SD[1:pmin(.N, cell_n)], by = dataset]
dist_dt <- dist_dt[cell_sizes > 0]

# UMI distribution plot
gp_umis_dist <- ggplot(dist_dt, aes(cell_sizes, dataset, fill = dataset)) +
  ggridges::geom_density_ridges2() +
  geom_vline(xintercept = umi_thr[1], linetype = "dashed", color = "red") +
  scale_x_continuous(
    breaks = 10^seq(1, 5),
    transform = "log10", labels = trans_format('log10', math_format(10^.x))
  ) +
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_manual(values = data_cols) +
  facet_grid("species", space = "free", scales = "free_y", drop = TRUE) +
  theme(
    strip.text = element_blank(),
    legend.position = "none"
  ) +
  labs(y = "", x = "UMIs / cell barcode", title = ttl)
gp_umis_dist


# Number of cells per dataset
gp_cells <- ggplot(filt_cells, aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, hjust = -0.2) +
  facet_grid("species", space = "free", scales = "free_y", drop = TRUE) +
  coord_flip() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  ) +
  labs(x = "", y = "", title = sprintf("Cells\n(%s<UMI<%s)", umi_thr[1], umi_thr[2]))
gp_cells


# Set Variables 
scdb_fig_dir <- "R_images"
map_dir <- "2501_Parse"
sub <- "top10000" 

# Ensure the directory exists before saving
if (!dir.exists(scdb_fig_dir)) {
  dir.create(scdb_fig_dir, recursive = TRUE)
}

# Arrange plots vertically
combined_plot <- gp_umis_dist + gp_cells + plot_layout(nrow = 1)

# Save the plot
ggsave(file.path(scdb_fig_dir, sprintf("UMI_dist_%s_%s.pdf", map_dir, sub)), 
       combined_plot, width = 14, height = 12)


```



```{r}
# ---- Per Dataset Plots ----

# Number of cells
gp_cells <- ggplot(filt_cells, aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, angle = 90, hjust = -0.2) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = sprintf("Cells\n(%s<UMI<%s)", umi_thr[1], umi_thr[2]))

# Number of genes
gp_genes <- ggplot(unique(sum_genes_plot[gene_umis > 0, .(dataset, species, gene)]), aes(dataset, fill = dataset)) +
  geom_bar(color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = data_cols) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 0.5, angle = 90, hjust = -0.2) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "none") +
  labs(x = "", y = "", title = "Genes\n(UMI>0)")

# ---- Per Cell Plots ----

# Plot cell UMI counts
gp_umis_cells <- ggplot(filt_cells, aes(dataset, cell_sizes, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = filt_cells[, median(cell_sizes), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  scale_y_continuous(trans = "log10", limits = c(umi_thr[1], NA)) +
  scale_fill_manual(values = data_cols) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = "UMIs / cell")

# Plot number of genes
gp_genes_cells <- ggplot(filt_cells, aes(dataset, cell_genes, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = filt_cells[, median(cell_genes), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  scale_y_continuous(trans = "log10", limits = c(NA, NA)) +
  scale_fill_manual(values = data_cols) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "", title = "Genes / cell")

# Plot gene UMI counts 
gp_umi_genes <- ggplot(sum_genes_plot, aes(dataset, gene_umis, fill = dataset)) +
  geom_boxplot() +
  geom_text(data = sum_genes_plot[gene_umis > 0, median(gene_umis), .(dataset, species)], aes(label = round(V1), y = V1), hjust = 0.5, vjust = -0.5) +
  facet_grid(. ~ species, space = "free", scales = "free", drop = TRUE) +
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "none") +
  scale_fill_manual(values = data_cols) +
  labs(x = "", y = "", title = "UMIs / gene")

# Combine plots
gps <- (gp_cells / gp_genes) | (gp_umis_cells / gp_genes_cells / gp_umi_genes)
ggsave(file.path(scdb_fig_dir, sprintf("cells_genes_%s.pdf", map_dir)), gps, width = 26, height = 15)


```


## Metacell clustering

```{r}
#| label: merge Parse and reference data matrices

# reference matrix
mat_nvec <- scdb_mat("Nvec")

# parse matrix
mat_parse <- scdb_mat("Parse_all")

# merge 
mat_id <- "Nvec_PARSE"
mat <- scm_merge_mats(mat_nvec, mat_parse)
mat@cell_metadata[mat@cell_metadata$type == "10x", ]$dataset <- "ACME_10x"
mat@cell_metadata[mat@cell_metadata$type == "MARS", ]$dataset <- "MARS"
scdb_add_mat(mat_id, mat)
```

Remove small cells.

```{r}
mat_id <- "Parse_all"
mat <- scdb_mat(mat_id)

# plot umi dist
mcell_plot_umis_per_cell_mod(
    mat_id = mat_id, 
    min_umis_cutoff = 100,
    output_file = file.path(scdb_fig_dir, sprintf("umi_distr.%s.pdf",mat_id)),
    breaks = 100
) 

# filter cells
x <- Matrix::colSums(mat@mat)
y <- Matrix::colSums(mat@mat>0)
large_cells <- names(which(x>10000))
small_cells <- names(which(x<100))
nogenes_cells <- names(which(x<50 & y<10))
message(sprintf(
  "I will remove:\n%s small cells\n%s large cells\n%s no-genes cells", 
  length(small_cells), length(large_cells), length(nogenes_cells)
))
mcell_mat_ignore_cells(
  new_mat_id = "PARSE",
  mat_id = mat_id, 
  ig_cells = c(mat@ignore_cells,small_cells,large_cells,nogenes_cells)
)

# load filtered matrix
mat_id <- "PARSE"
mat <- scdb_mat(mat_id)
```

Ignore orphans with low UMI counts.

```{r}
erccs <- rownames(mat@mat)[grepl("ERCC",rownames(mat@mat))] 
peaks_counts <- rowSums(as.matrix(mat@mat[grepl("orphan",rownames(mat@mat)),]))
peaks_ignore <- names(peaks_counts) #names(which(peaks_counts<100))
mcell_mat_ignore_genes(new_mat_id = mat_id, mat_id = mat_id, ig_genes = c(erccs, peaks_ignore))
mat <- scdb_mat(mat_id)
```

Marker genes selection.

```{r}
# add gene stats and reload the matrix
gstat_id <- mat_id
mcell_add_gene_stat(
    gstat_id = gstat_id, 
    mat_id = mat_id, 
    force = TRUE
)
mat <- scdb_mat(mat_id)

# exclude histones, ribosomal and heath-shock proteins from markers
histones <- gnan[grepl("Histone/", pfam), ]$gene
ribosomal_prots <- gnan[grepl("Ribosomal.*/", pfam, perl = TRUE), ]$gene
hsps <- gnan[grepl("HSP", pfam), ]$gene

# exclude mOrange if present
morange <- rownames(mat@mat)[grepl("mOrange",rownames(mat@mat))] 

# exclude batch-correlated genes (identified after first clustering iteration)
batch_genes <- ""
batch_genes <- tryCatch(
  readLines(file.path(scdb_dir, sprintf("batchgenes.%s.txt", mat_id))),
  error = function(e) {
    message("Batch correlated genes not defined yet.")
    c()
  }
)

# marker genes
gset_id <- sprintf("%s_clust_markers", mat_id)
bl_genes <- c(histones, ribosomal_prots, hsps, morange, batch_genes)
writeLines(bl_genes, file.path(scdb_dir, "blacklisted.genes.txt"))
mcell_gset_filter_multi(
    gstat_id = gstat_id,
    gset_id = gset_id,
    blacklist = bl_genes,
    T_tot = 30, 
    T_top3 = 2, 
    T_szcor = -0.05, 
    T_niche = 0.05,
    force_new = TRUE
)
gset <- scdb_gset(gset_id)
gset@set_names <- gset_id
scdb_add_gset(gset_id, gset)

mcell_plot_gstats_mod(
    gstat_id, 
    gset_id, 
    output_file = file.path(scdb_fig_dir, sprintf("gstat.%s.pdf",gset_id)),
    width = 9.5, height = 3.5
)

```

Construct metacell object.

```{r}
K_cgraph <- 30
graph_id <- sprintf("%s_graphk%s",mat_id,K_cgraph)
gset_id <- sprintf("%s_clust_markers",mat_id)
mcell_add_cgraph_from_mat_bknn(
    mat_id, gset_id, graph_id, 
    K = K_cgraph, 
    dsamp = FALSE
)

# resample graph and compute metacells for each resampling
min_mc_size <- 20
p_resamp <- 0.75
n_resamp <- 100
coc_id <- sprintf("%s_coc%s_min%s",mat_id,n_resamp,min_mc_size)
mcell_coclust_from_graph_resamp(
    coc_id, graph_id, 
    min_mc_size = min_mc_size, 
    p_resamp = p_resamp, 
    n_resamp = n_resamp
)

# final graph and metacells from co-occurence in resampled graphs
K <- 30
mc_id <- sprintf("%s_K%s", mat_id, K)
mcell_mc_from_coclust_balanced(
    mc_id, coc_id, mat_id,
    K = K, 
    min_mc_size = min_mc_size,  
    alpha = 2
)
mc <- scdb_mc(mc_id)

```

***

Identify genes strongly correlated with batch distribution

```{r}
bat_list  <- sca_batch_correlated_genes_mc(
  mc_object = mc, 
  mat_object = mat, 
  cor_thr_q = 0.99,
  method = "pearson",
	batch_field = "type",
	do_plots = TRUE,
	output_file = file.path(scdb_fig_dir, sprintf("batch_corr.%s.pdf",mc_id)),
  width = 6, height = 6
)
writeLines(bat_list$genes, file.path(scdb_dir, "batch.genes.txt"))
```

Now re-do clustering with batch-correlated genes blacklisted in marker selection.

***

# Metacell projection

Generate reference atlas object

```{r}
atlas_id <- "Nvec_K30_atlas"
mat_id <- "Nvec"
mc_id <- "Nvec_K30_atlas"
graph_id <- "Nvec_graphk100"
gset_id <- "Nvec_clust_markers"
naming_type <- "Nvec"
mc_ann <- fread(file.path(scdb_dir, "annotation.Nvec_K30_atlas.tsv"))
setnames(mc_ann, c("type_id", "type_name", "type_color"))
class(mc_ann) <- "data.frame"
mcell_new_mcatlas(
  atlas_id = atlas_id,
  mat_id = mat_id,
  naming_type = naming_type,
  mc_id = mc_id,
  graph_id = graph_id,
  gset_id = gset_id,
  type_annot = mc_ann
)
```

Projection

```{r}
# reference
atlas_id <- "Nvec_K30_atlas"
atlas <- scdb_mcatlas(atlas_id)
atlas_ann <- fread(file.path(scdb_dir, sprintf("annotation.%s.tsv", atlas_id)))
setnames(atlas_ann, "metacell", "a_mcid")

# query
qmat_id <- "PARSE"
message(qmat_id)
qmc_fn <- list.files(
  scdb_dir, pattern = sprintf("mc.%s_K\\d+\\.Rda", qmat_id)
)
qmc_id <- str_extract(qmc_fn, "(?<=mc\\.).+(?=\\.Rda)")
q_gset_id <- sprintf("%s_clust_markers", qmat_id)
qmat_naming_type <- "Nvec"

# projection mc level
suff <- "mc2mc"
new_mc_id <- sprintf("%s_%s", qmc_id, suff)
mc2mc <- tryCatch({
 mcatlas_annotate_mc_by_mc2mc_projection(
    atlas_id = atlas_id,
    qmc_id = qmc_id,
    qmat_naming_type = qmat_naming_type,
    new_qmc_id = new_mc_id,
    q_gset_id = q_gset_id,
    fig_cmp_dir = scdb_fig_dir
  )
}, error = function(e) {
  mcatlas_annotate_mc_by_mc2mc_projection(
    atlas_id = atlas_id,
    qmc_id = qmc_id,
    qmat_naming_type = qmat_naming_type,
    new_qmc_id = new_mc_id,
    q_gset_id = NULL,
    fig_cmp_dir = scdb_fig_dir
  )
})
setDT(mc2mc)
mc2mc[, a_mcid := as.integer(a_mcid)]
mc2mc <- merge.data.table(
  mc2mc, atlas_ann, by = "a_mcid",
  all.x = TRUE, sort = FALSE
)
an_fn <- file.path(scdb_dir, sprintf("%s.%s.tsv", suff, qmc_id))
message(an_fn)
fwrite(
  mc2mc,
  an_fn,
  sep = "\t",
  col.names = TRUE,
  quote = FALSE
)

```

Save annotation files

```{r}
suff <- "mc2mc"
mat_id <- "PARSE"
mc_fn <- list.files(
  scdb_dir, pattern = sprintf("mc.%s_K\\d+\\.Rda", mat_id)
)
mc_id <- str_extract(mc_fn, "(?<=mc\\.).+(?=\\.Rda)")
an_fn <- file.path(scdb_dir, sprintf("%s.%s.tsv", suff, mc_id))
message(an_fn)
an <- fread(an_fn)
mc2mc_an <- an[, .(q_mcid, cell_type, color)]
setnames(mc2mc_an, "q_mcid", "metacell")
fwrite(
  mc2mc_an,
  file.path(scdb_dir, sprintf("annotation.%s.%s.tsv", suff, mc_id)),
  sep = "\t"
)
```

## Compare cell types per method

```{r}
mat_ids <- c(
  "Nvec", "PARSE"
)
mc_ids <- c(
  "Nvec_K30_atlas", "PARSE_K30"
)

suff <- "mc2mc"
ann_dt <- rbindlist(lapply(seq_along(mat_ids), function(i) {

  mat_id <- mat_ids[i]
  mc_id <- mc_ids[i]
  message(mat_id, " ", mc_id)

  mat <- scdb_mat(mat_id)
  mc <- scdb_mc(mc_id)
  
  if (i == 1) {
    an_fn <- file.path(scdb_dir, sprintf("annotation.%s.tsv", mc_id))
  } else {
    an_fn <- file.path(scdb_dir, sprintf("annotation.%s.%s.tsv", suff, mc_id))
  }
  an <- fread(an_fn)
  
  cz <- Matrix::colSums(mat@mat)
  sc <- data.table(
    cell = names(mc@mc),
    metacell = mc@mc
  )
  sc[, cell_size := cz[cell]]
  dt <- merge.data.table(sc, an, by = "metacell", all.x = TRUE, sort = TRUE)
  dt[, dataset := mat_id]
  dt
  
}))

# add broad cell types annotations
bcts <- c(
    "cnidocyte", "muscle", "gastrodermis",
    "digestive_filaments", "epidermis", "precursors", "neuron", "gland"
)
ct_pattern <- paste(c(bcts), collapse = "|")

ann_dt[, broad_cell_type := str_extract(cell_type, ct_pattern)]
ann_dt[, broad_cell_type := factor(broad_cell_type, levels = bcts)]

fwrite(ann_dt, file.path(scdb_dir, "annotations.compare.tsv"), sep = "\t")
```

UMI count/cells of each batch aggregated per broad cell type

```{r}
ann_dt <- fread(file.path(scdb_dir, "annotations.compare.tsv"))

mat_ids <- c("MARS","ACME", "Parse_all")

data_cols <- c(
  "MARS" = "#D53E4F",
  "ACME" = "#1F78B4",
  "Nvec" = "#458B20",
  "PARSE" = "#5E4FA2",
  sample_cols
)
bct_cols <- c(
  "cnidocyte" = "#CD96CD",
  "muscle" = "#FFD700",
  "gastrodermis" = "#458B00",
  "digestive_filaments" = "#CD2626",
  "epidermis" = "#00C5CD",
  "precursors" = "#BEBEBE",
  "neuron" = "#101CDE",
  "gland" = "#ff8800"
)

ann_dt[, dataset := factor(dataset, levels = names(data_cols))]
ann_dt[, broad_cell_type := factor(broad_cell_type, levels = names(bct_cols))]

gp_cz <- ggplot(
    ann_dt,
    aes(broad_cell_type, cell_size, fill = dataset)
  ) +
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    outlier.color = NA
  ) +
  scale_y_continuous(trans = "log10") +
  scale_fill_manual(values = data_cols) +
  labs(
    y = "cell UMIs", x = "broad cell type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

ggsave(
  file.path(scdb_fig_dir, "cell_size_dataset.pdf"),
  gp_cz, width = 6, height = 4
)
```

Cell type composition per dataset

```{r}
ann_ct <- copy(ann_dt)
ann_ct[, dataset := factor(dataset, levels = c(levels(ann_ct$dataset), "cell_type"))]

gp_nc <- ggplot(ann_ct, aes(dataset, fill = broad_cell_type)) +
  geom_bar(position = "fill", color = "black") +
  scale_x_discrete(expand = expansion(mult = c(0, 0.5))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) +
  scale_fill_manual(values = bct_col) +
  # add broad_cell_type labels on top of the barplot
  geom_text(
    aes(label = ..count..),
    stat = "count",
    position = position_fill(vjust = 0.5),
    vjust = 0.5
  ) +
  # add broad_cell_type labels on the right-hand side of the barplot
  geom_text(
    data = ann_dt[dataset == tail(unique(ann_dt$dataset), 1)], # use only the right-most bar
    aes(x = "cell_type", label = broad_cell_type),  # move labels to the right
    stat = "count",
    position = position_fill(vjust = 0.5),  # center vertically within the bar
    hjust = 0.5
  ) +
  labs(y = "fraction of cells", x = "") + 
  theme(
    legend.position = "none", 
    panel.border = element_blank(), 
    panel.grid.major.x = element_blank(),
    # rotate x axis labels 90 degrees
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks = element_blank()
  ) 

ggsave(
  file.path(scdb_fig_dir, "cell_composition_dataset.pdf"),
  gp_nc, width = 4, height = 6
)

# split parse per condition
cell_data <- as.data.table(mat@cell_metadata, keep.rownames = "cell")[, .(cell, dataset)]
setnames(cell_data, "dataset", "sample")
ann_ct <- merge.data.table(ann_ct, cell_data, by = "cell", all.x = TRUE)
ann_ct[dataset == "Nvec", sample := "Nvec"]
ann_ct[, sample := factor(sample, levels = c(names(sample_cols), "Nvec"))]

# add dissociation info
diss_vect <- c(
  "Nvec_ACMEsorb_GM" = "mechanical",
  "Nvec_EMA_ACME_GM" = "mechanical",
  "Nvec_DSP" = "enzymatic",
  "Nvec_Parse_fix" = "enzymatic",
  "Nvec_ACMEsorb_cold_PR" = "enzymatic",
  "Nvec_Vivophix_sonic" = "mechanical",
  "Nvec_DSP_CMFSW" = "enzymatic",
  "Nvec" = "reference"
)
ann_ct[, dissociation := diss_vect[as.character(sample)]]

gp_parse <- ggplot(ann_ct, aes(sample, fill = broad_cell_type)) +
  geom_bar(position = "fill", color = "black") +
  scale_x_discrete(expand = expansion(mult = c(0, 0.5))) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) +
  scale_fill_manual(values = bct_cols) +
  # add broad_cell_type labels on top of the barplot
  geom_text(
    aes(label = ..count..),
    stat = "count",
    position = position_fill(vjust = 0.5),
    vjust = 0.5
  ) +
  # add broad_cell_type labels on the right-hand side of the barplot
  geom_text(
    data = ann_ct[sample == tail(unique(ann_ct$sample), 1)], # use only the right-most bar
    aes(x = "cell_type", label = broad_cell_type),  # move labels to the right
    stat = "count",
    position = position_fill(vjust = 0.5),  # center vertically within the bar
    hjust = 0.5
  ) +
  facet_grid(.~dissociation, scale = "free", space = "free") +
  labs(y = "fraction of cells", x = "") + 
  theme(
    legend.position = "none", 
    panel.border = element_blank(), 
    panel.grid.major.x = element_blank(),
    # rotate x axis labels 90 degrees
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks = element_blank()
  ) 

ggsave(
  file.path(scdb_fig_dir, "cell_composition_dataset_sample.pdf"),
  gp_parse, width = 10, height = 6
)

```

## Reorder query

Load metacell data.

```{r}
mat_id <- "PARSE"
mc_id <- "PARSE_K30"
mat <- scdb_mat(mat_id)
mc <- scdb_mc(mc_id)
mc_ct <- fread(file.path(scdb_dir, sprintf("annotation.mc2mc.%s.tsv", mc_id)))
```

Reorder metacells

```{r}
# add broad cell types annotations
bcts <- c(
    "cnidocyte", "muscle", "gastrodermis",
    "digestive_filaments", "epidermis", "precursors", "neuron", "gland"
)
ct_pattern <- paste(c(bcts), collapse = "|")
mc_ct[, broad_cell_type := str_extract(cell_type, ct_pattern)]

# order by broad cell types
mc_ct[, broad_cell_type := factor(broad_cell_type, levels = bcts)]
setorder(mc_ct, broad_cell_type, metacell)

# order cell types
cts <- unique(mc_ct$cell_type)
mc_ct[, cell_type := factor(cell_type, levels = cts)]
setorder(mc_ct, cell_type, metacell)

# reorder metacells
mc_id <- sprintf("%s_ord", mc_id)
mc <- mc_reorder(mc, as.integer(mc_ct$metacell))
mc@colors <- mc_ct$color
scdb_add_mc(mc_id, mc)

# save annots
mc_ct[metacell := 1:.N]
fwrite(mc_ct, file.path(scdb_dir, sprintf("annotation.%s.tsv",mc_id)), sep="\t", col.names=TRUE)
```

# Metacell plots

Load metacell data.

```{r}
mat_id <- "PARSE"
mc_id <- "PARSE_K30_ord"
mat <- scdb_mat(mat_id)
mc <- scdb_mc(mc_id)
mc_ct <- fread(file.path(scdb_dir, sprintf("annotation.%s.tsv", mc_id)))
```

Plot heatmaps of marker genes' expression in pruned and ordered metacell solution.

```{r}
niche_order <- mc_ct$metacell

clust_col_df <- data.frame("cell_type"=mc_ct[,cell_type])
rownames(clust_col_df) <- mc_ct[,metacell]
clust_col_df$cell_type <- factor(clust_col_df$cell_type, levels=unique(clust_col_df$cell_type))

clust_col_sc_df <- data.frame("cell_type"=mc_ct[match(mc@mc,metacell),cell_type])
rownames(clust_col_sc_df) <- names(mc@mc)
clust_col_sc_df$cell_type <- factor(clust_col_sc_df$cell_type, levels=unique(clust_col_df$cell_type))

clust_col_colors <- mc_ct[,setNames(color,cell_type)]
clust_col_colors <- list("cell_type" = clust_col_colors[!duplicated(clust_col_colors)])

cmod_markers_per_clust_genes <- 20
cmod_markers_gene_min_fold <- 2

bl <- c(
  readLines(file.path(scdb_dir, "blacklisted.genes.txt")),
  grep("orphan", rownames(mc@mc_fp), value = TRUE)
)

marker_data_list <- scp_plot_cmod_markers_select(
  mc, mat, 
  clust_ord = niche_order,
  per_clust_genes = cmod_markers_per_clust_genes, 
  gene_min_fold = cmod_markers_gene_min_fold, 
  transverality_N = 60,
  transv_excluded_mc = mc_ct[grep("neuron",cell_type)]$metacell,
  black_list = bl,
  sub_list_mc = NULL, 
  gene_list = NULL, 
  order_genes = TRUE, 	
  gene_annot_file = "annotation/Nematostella_DToL_FINAL.tsv",
  annot_header = FALSE
)

hm_height=28
hm_width=28
scp_plot_cmod_markers_mc(
  marker_data_list, 
  clust_col=clust_col_df, clust_col_color=clust_col_colors, 
  clust_anno_size=unit(2,"mm"),
  output_file=file.path(scdb_fig_dir,sprintf("Gene_expression_%s.pdf",mc_id)),
  height=hm_height,
  width=hm_width,
  show_gene_names=TRUE, show_clust_borders=TRUE,
)

# hm_height=28
# hm_width=28
# scp_plot_cmod_markers_sc(
#   marker_data_list, mc, mat,
#   clust_col=clust_col_sc_df, clust_col_color=clust_col_colors,
#   clust_anno_size=unit(2,"mm"),
#   output_file=file.path(scdb_fig_dir,sprintf("Gene_expression_%s_sc.pdf",mc_id)),
#   height=hm_height,
#   width=hm_width,
#   show_gene_names=TRUE, show_clust_borders=TRUE
# )

# figures
hm_height=12
hm_width=12
scp_plot_cmod_markers_mc(
  marker_data_list, 
  clust_col=clust_col_df, clust_col_color=clust_col_colors, 
  clust_anno_size=unit(2,"mm"),
  min_expression_fc = 0, max_expression_fc = 4,
  output_file=file.path(scdb_fig_dir,sprintf("Gene_expression_minimal_%s.pdf",mc_id)),
  height=hm_height,
  width=hm_width,
  show_gene_names=FALSE, show_mc_names = FALSE,
  show_clust_borders=FALSE
)
 
# hm_height=12
# hm_width=12
# scp_plot_cmod_markers_sc(
#   marker_data_list, mc, mat,
#   clust_col=clust_col_sc_df, clust_col_color=clust_col_colors,
#   clust_anno_size=unit(2,"mm"),
#   min_expression_fc = 0, max_expression_fc = 4,
#   output_file=file.path(scdb_fig_dir,sprintf("Gene_expression_minimal_%s_sc.pdf",mc_id)),
#   height=hm_height,
#   width=hm_width,
#   show_gene_names=FALSE, show_mc_names = FALSE,
#   show_clust_borders=FALSE
# )

```

Plot 2D projections

```{r}
# load graph
graph_id <- list.files(
  scdb_dir, pattern = sprintf("cgraph.%s_graphk\\d+\\.Rda", mat_id)
) %>% str_remove(".Rda") %>% str_remove("cgraph\\.")
mc2d_id <- sprintf("%s_2dproj", mc_id)
tgconfig::override_params(file.path(scdb_dir, sprintf("metacell_params.%s.yaml", mc_id)), "metacell")
mcell_mc2d_force_knn(mc2d_id = mc2d_id, mc_id = mc_id, graph_id = graph_id)
mc2d <- scdb_mc2d(mc2d_id)

# 2d
scp_plot_sc_2d(
  mc2d, mc, 
  plot_edges = TRUE, 
  plot_mc_name = TRUE, 
  plot_mcs = TRUE,
  output_file = file.path(scdb_fig_dir,sprintf("2D_%s.pdf",mc_id)),
  width = 12, 
  height = 12
)

```

Batch effect

```{r}
scp_batch_effects_per_mc(
	mc, 
	mat, 
	mc_color = mc@colors, 
	batch_field = "dataset",
	batch_color = data_cols[sort(unique(mat@cell_metadata$dataset))],
	output_file = file.path(scdb_fig_dir, sprintf("%s.batch_effects_mc.pdf", mc_id)),
	width = 24, height = 12
)
```

Cell type sankey

```{r}
# combine dataset - cell - metacell - cell type info
cell_data <- as.data.table(mat@cell_metadata, keep.rownames = "cell")
meta_data <- fread(file.path(scdb_dir, sprintf("annotation.%s.tsv", mc_id)))
mcan_data <- data.table(metacell=mc@mc, cell=names(mc@mc))
dta <- merge.data.table(
  cell_data[, .(cell, dataset)],
  mcan_data,
  by = "cell"
)
dta <- merge.data.table(
  meta_data,
  dta,
  by = "metacell"
)

# broad cell type colors
bct_cols <- c(
  "cnidocyte" = "#CD96CD",
  "muscle" = "#FFD700",
  "gastrodermis" = "#458B00",
  "digestive_filaments" = "#CD2626",
  "epidermis" = "#00C5CD",
  "precursors" = "#BEBEBE",
  "neuron" = "#101CDE",
  "gland" = "#ff8800"
)

dta[, broad_cell_type_color := bct_col[broad_cell_type]]

# save
setcolorder(dta, c("metacell", "cell_type", "color", "broad_cell_type", "broad_cell_type_color", "cell", "dataset"))
fwrite(dta, file.path(scdb_dir, sprintf("annotation.cell.%s.tsv", mc_id)), sep = "\t", col.names = TRUE)
```
